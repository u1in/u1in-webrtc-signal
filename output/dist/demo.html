<html lang="en">
  <body>
    <video id="local-video" autoplay muted></video>
    <video id="remote-video" autoplay muted></video>
    <button onclick="connect()">连接</button>
  </body>

  <script src="http://127.0.0.1:3123/signal.min.js"></script>

  <script>
    window.videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
    document.querySelector("#local-video").srcObject = videoStream;
  </script>

  <script>
    const signal = new Signal({
      // default.json配置的ws.port
      wsUrl: "ws://127.0.0.1:3124",
    });

    // 初始化代码，用于注册唯一id
    signal.on("welcome", ({ senderId, payload: id }) => {
      // id回调
    });

    // 注册offer事件全局监听，处理外来接入请求
    signal.on("offer", ({ senderId, payload: offer }) => {
      signal
        .createPeer(senderId, (peer) => {
          if (videoStream) {
            videoStream.getTracks().map((track) => {
              peer.addTrack(track, videoStream);
            });
          }
          peer.ontrack = (event) => {
            document.querySelector("#local-video").srcObject = event.streams[0];
          };
          return peer;
        })
        .saveOffer(offer)
        .createAnswer()
        .answer()
        .do();
    });

    // 主动发起请求
    const sendOffer = (targetId) => {
      signal
        .createPeer(targetId, (peer) => {
          if (videoStream) {
            videoStream.getTracks().map((track) => {
              peer.addTrack(track, videoStream);
            });
          }
          peer.ontrack = (event) => {
            document.querySelector("#local-video").srcObject = event.streams[0];
          };
          return peer;
        })
        .createOffer()
        .offer()
        .do();
    };
  </script>
</html>
